<%= calendar_date_select_includes "silver" %>

<% content_for :header_tags do %>
    <%= auto_discovery_link_tag(:atom, {:action => 'index', :format => 'atom', :key => User.current.rss_key}) %>
		<%= stylesheet_link_tag 'redmine_lesite_projects', :plugin => 'redmine_lesite_projects' %>
		<%= javascript_include_tag 'tablekit', :plugin => 'redmine_lesite_projects' %>
		<%= javascript_include_tag 'jquery-1.3.2.min.js', :plugin => 'redmine_schedules'  %>
		<%= javascript_include_tag "projects_index", :plugin => "redmine_lesite_projects" %>
		<%= javascript_include_tag "jeditable", :plugin => "redmine_lesite_projects" %>
<% end %>

<div class="contextual">
		Show 
			<select id="show_filter">
				<option value="active" <%= "selected='selected'" if params[:show]=='active' || session[:show_projects_filter] == "active" %>>Active</option>
				<option value="all" <%= "selected='selected'" if params[:show]=='all' || params[:show].blank? && session[:show_projects_filter] != "active" %>>All</option>
			</select>
		<%= render :partial => "projects/new_from_boilerplate" %>
    <%= link_to(l(:label_project_new), {:controller => 'projects', :action => 'new'}, :class => 'icon icon-add') + ' |' if User.current.allowed_to?(:add_project, nil, :global => true) %>
    <%= link_to(l(:label_issue_view_all), { :controller => 'issues' }) + ' |' if User.current.allowed_to?(:view_issues, nil, :global => true) %>
    <%= link_to(l(:label_overall_spent_time), { :controller => 'time_entries' }) + ' |' if User.current.allowed_to?(:view_time_entries, nil, :global => true) %>
    <%= link_to l(:label_overall_activity), { :controller => 'activities', :action => 'index' }%>
</div>

<h2><%=l(:label_project_plural)%></h2>

<table id="projects" cellspacing="0" cellpadding="0" class="sortable">
	<thead>
		<tr>
			<th>Project</th>
			<th>Phase</th>
			<th>Deadline</th>
			<th>Due In</th>
			<% TimeEntryActivity.find(:all,:select=>"id,name").each do |activity| -%>
				<th>
					<%= activity.name %><br />Budget<br />
					<span style="font-size:smaller">(used/est)</span>
				</th>
			<% end -%>
			<th>
				Total Budget<br />
				<span style="font-size:smaller">(used/est)</span>
			</th>
			<th>Notes</th>
		</tr>
	</thead>
	<tbody>
	<% @projects.each do |project| %>
		<tr class="<%= project.root? ? 'root' : nil %> <%= cycle('even','odd') %> <%= project.deadline_passed? ? 'overdue' : nil %>">
			<td class="<%= User.current.member_of?(project) ? 'my-project' : nil %>">
				<%= project.ancestors.map { |a| "#{a.name} &#187; " } %>
				<% if project.versions.present? -%>
					<%= link_to project.name, "/projects/#{project.to_param}/roadmap" %>
				<% else -%>
					<%= link_to project.name, project %>
				<% end -%>
			</td>
			<td><div class="edit_select" id="phase_<%= project.id %>"><%= project.phase %></div></td>
			<td class="deadline">
				<a href="#" class="edit_deadline">
					<% if project.deadline.present? -%>
						<%= project.deadline.strftime("%b %d")  %>
					<% else -%>
					 Click to edit
					<% end -%>
				</a>
				<div class="deadline_editor">
					<%= calendar_date_select_tag "date", @date, :id => "deadline_#{project.id}", :class => "deadline" %>
					<button id="deadline_<%= project.id %>" class="close_deadline_editor submit_new_deadline">OK</button>
					<button class="close_deadline_editor">X</button>
				</div>
			</td>
			<td class="due_date">
				<%= "#{project.deadline < Date.today ? :"Overdue By " : "Due In "}" + distance_of_date_in_words(Date.today, project.deadline) if project.deadline.present? %>
			</td>
			<% TimeEntryActivity.find(:all,:select=>"id,name").each do |activity| -%>
				<td class="<%=EstimatedActivityHour.overbudget?(project,activity) ? 'overbudget' : nil %>"><%= EstimatedActivityHour.used_over_estimated(project,activity) %></td>
			<% end -%>
			<td class="<%= EstimatedActivityHour.total_overbudget?(project) ? 'overbudget' : nil %>"><%= EstimatedActivityHour.total_used_over_estimated(project) %></td>
			<td><div class='edit' id='notes_<%= project.id %>'><%= project.notes %></div></td>
		</tr>
	<% end -%>
	</tbody>
</table>

<% if User.current.logged? %>
<p style="text-align:right;">
<span class="my-project"><%= l(:label_my_projects) %></span>
</p>
<% end %>

<% other_formats_links do |f| %>
	<%= f.link_to 'Atom', :url => {:key => User.current.rss_key} %>
<% end %>

<% html_title(l(:label_project_plural)) -%>

<script>
	jQuery(document).ready(function(){
		jQuery('.edit_select').editable('lesite_projects/in_place_edit', { 
	     data   : " {<%= Phase.all.map{ |p| "'#{p.name}':'#{p.name}'" }.join(',') %>}",
	     type   : 'select',
	     submit : 'OK'
	 });
	})
</script>
